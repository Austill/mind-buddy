version: '3.8'

services:
  # MongoDB Database Service
  mongodb:
    image: mongo:latest
    container_name: mindbuddy-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGODB_DB_NAME:-mind_buddy}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - mindbuddy-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Flask Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mindbuddy-backend
    environment:
      # Flask Configuration
      FLASK_ENV: ${FLASK_ENV:-production}
      SECRET_KEY: ${SECRET_KEY:-change-me-in-production}
      
      # MongoDB Configuration
      MONGO_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGODB_DB_NAME:-mind_buddy}?authSource=admin
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:-mind_buddy}
      
      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-jwt-secret-key}
      
      # CORS Configuration (add frontend URL)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://frontend:3000}
      
      # AI/LLM Configuration
      HF_MODEL_NAME: ${HF_MODEL_NAME:-facebook/blenderbot-400M-distill}
      MAX_NEW_TOKENS: ${MAX_NEW_TOKENS:-100}
      TEMPERATURE: ${TEMPERATURE:-0.7}
      TOP_P: ${TOP_P:-0.9}
      
      # Payment Configuration (Flutterwave)
      FLW_SECRET_KEY: ${FLW_SECRET_KEY:-}
      FLW_SIGNATURE_KEY: ${FLW_SIGNATURE_KEY:-}
      FLW_PLAN_ID: ${FLW_PLAN_ID:-}
      REDIRECT_URL: ${REDIRECT_URL:-}
      
      # Logging
      LOGGING_LEVEL: ${LOGGING_LEVEL:-INFO}
    
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    networks:
      - mindbuddy-network
    
    volumes:
      # Optional: Mount backend source for development
      # - ./backend:/app
      - backend_cache:/app/.cache  # For HuggingFace model cache
    
    restart: unless-stopped
    
    # Override CMD for development (if needed)
    # command: flask run --host=0.0.0.0

  # React Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mindbuddy-frontend
    environment:
      # API Configuration
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://backend:5000}
      VITE_API_URL: ${VITE_API_URL:-http://backend:5000}
    
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    
    depends_on:
      - backend
    
    networks:
      - mindbuddy-network
    
    restart: unless-stopped

volumes:
  # Persistent MongoDB data
  mongodb_data:
    driver: local
  
  # MongoDB configuration
  mongodb_config:
    driver: local
  
  # HuggingFace model cache (for LLM models)
  backend_cache:
    driver: local

networks:
  mindbuddy-network:
    driver: bridge
